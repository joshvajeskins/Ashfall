# Prompt 2: Backend Server - Dungeon API Routes

## Goal
Implement the dungeon API endpoints that sign and submit transactions to the Move contracts.

## Pre-Check: Review Issues
Before starting, check these issue docs:
- `docs/issues/move/README.md` - Contract interaction issues
- `docs/issues/movement/README.md` - Network/RPC issues

## Context
The frontend's `dungeonService.ts` calls these endpoints:
- `POST /api/dungeon/exit-success` - Claims loot on victory
- `POST /api/dungeon/complete-floor` - Advances floor
- `POST /api/dungeon/complete-boss` - Completes boss encounter
- `POST /api/dungeon/player-died` - Burns items on death

## Tasks

### 2.1 Create Dungeon Routes (src/routes/dungeon.ts)

```typescript
// POST /api/dungeon/complete-floor
// Body: { playerAddress, enemiesKilled, xpEarned }
// Calls: dungeon::complete_floor(server, player, enemies_killed, xp_earned)

// POST /api/dungeon/complete-boss
// Body: { playerAddress, xpEarned }
// Calls: dungeon::complete_boss_floor(server, player, xp_earned)

// POST /api/dungeon/exit-success
// Body: { playerAddress }
// Calls: dungeon::exit_dungeon_success(server, player)

// POST /api/dungeon/player-died
// Body: { playerAddress }
// Calls: dungeon::player_died(server, player)
```

### 2.2 Create Dungeon Service (src/services/dungeonService.ts)

Functions that build and submit transactions:

```typescript
export async function completeFloor(
  player: string,
  enemiesKilled: number,
  xpEarned: number
): Promise<TransactionResult>

export async function completeBossFloor(
  player: string,
  xpEarned: number
): Promise<TransactionResult>

export async function exitDungeonSuccess(
  player: string
): Promise<TransactionResult>

export async function playerDied(
  player: string
): Promise<TransactionResult>
```

### 2.3 Transaction Builder Pattern

Each transaction should:
1. Build the entry function payload
2. Sign with server account
3. Submit to chain
4. Wait for confirmation
5. Return txHash and success status

```typescript
const payload = {
  function: `${CONTRACT_ADDRESS}::dungeon::complete_floor`,
  typeArguments: [],
  functionArguments: [playerAddress, enemiesKilled, xpEarned]
};
```

### 2.4 Error Handling

Handle common errors:
- `E_NOT_IN_DUNGEON` (error code 1)
- `E_UNAUTHORIZED` (error code 3)
- `E_CHARACTER_DEAD` (error code 5)
- Network timeouts
- Insufficient gas

Return structured errors:
```typescript
{
  success: false,
  error: "Player is not in dungeon",
  errorCode: "E_NOT_IN_DUNGEON"
}
```

### 2.5 Add Loot Generation Route

```typescript
// POST /api/dungeon/add-loot
// Body: { playerAddress, floor, itemType, rarity }
// Creates item and adds to pending loot
```

This requires calling:
- `loot::generate_weapon` or similar
- `dungeon::add_pending_weapon`

## Acceptance Criteria
- [ ] All 4 dungeon endpoints respond correctly
- [ ] Transactions are properly signed by server
- [ ] Errors return meaningful messages
- [ ] TypeScript types match contract expectations

## Testing
```bash
# Test health
curl http://localhost:3001/api/health

# Test exit (will fail without deployed contracts, but should not crash)
curl -X POST http://localhost:3001/api/dungeon/exit-success \
  -H "Content-Type: application/json" \
  -d '{"playerAddress": "0x1"}'
```

## Next Prompt
Prompt 3 will deploy contracts to Movement testnet.

# Prompt 1: Backend Server - Project Setup & Core Structure

## Goal
Create the backend game server that handles server-authorized transactions for the Ashfall game.

## Pre-Check: Review Issues
Before starting, check these issue docs for known problems:
- `docs/issues/tooling/README.md` - Build/deployment issues
- `docs/issues/movement/README.md` - Network configuration issues

## Context
The frontend expects API endpoints at `/api/dungeon/*` but they don't exist. The Move contracts require a server-authorized signer for:
- Floor completion (`complete_floor`)
- Boss completion (`complete_boss_floor`)
- Dungeon exit (`exit_dungeon_success`)
- Player death (`player_died`)

## Tasks

### 1.1 Create Server Directory Structure
```
backend/
├── src/
│   ├── index.ts              # Express app entry
│   ├── config/
│   │   ├── index.ts          # Environment config
│   │   └── movement.ts       # Movement network config
│   ├── routes/
│   │   ├── index.ts          # Route aggregator
│   │   └── dungeon.ts        # Dungeon API routes
│   ├── services/
│   │   ├── moveClient.ts     # Aptos SDK client
│   │   └── dungeonService.ts # Dungeon transaction logic
│   ├── middleware/
│   │   └── auth.ts           # Player authentication
│   └── types/
│       └── index.ts          # TypeScript types
├── package.json
├── tsconfig.json
└── .env.example
```

### 1.2 Initialize Package
```json
{
  "name": "ashfall-server",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "@aptos-labs/ts-sdk": "^1.33.1",
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "tsx": "^4.7.0",
    "typescript": "^5.3.3"
  }
}
```

### 1.3 Create Core Server (src/index.ts)
- Express server on port 3001
- CORS enabled for frontend
- JSON body parsing
- Health check endpoint
- Mount dungeon routes at `/api/dungeon`

### 1.4 Create Movement Client (src/services/moveClient.ts)
- Initialize Aptos client for Movement testnet
- Load server private key from env
- Create signer account
- Helper functions for:
  - `submitTransaction(payload)`
  - `viewFunction(module, fn, args)`

### 1.5 Create Environment Config
```env
# .env.example
PORT=3001
MOVEMENT_RPC_URL=https://testnet.movementnetwork.xyz/v1
SERVER_PRIVATE_KEY=your_server_private_key_here
CONTRACT_ADDRESS=0xYOUR_DEPLOYED_ADDRESS
```

## Acceptance Criteria
- [ ] Server starts without errors on `npm run dev`
- [ ] Health check returns 200 at `/api/health`
- [ ] Movement client initializes with server account
- [ ] TypeScript compiles without errors

## File Limits
- Each file max 150 lines
- Split large files into modules

## Next Prompt
Prompt 2 will implement the dungeon API routes and transaction logic.

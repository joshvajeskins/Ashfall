# Prompt 4: Frontend Transaction Integration

## Goal
Connect frontend to real blockchain transactions via Privy wallet and backend API.

## Pre-Check: Review Issues
Before starting, check these issue docs:
- `docs/issues/ui/README.md` - React/Next.js issues
- `docs/issues/movement/README.md` - Wallet integration issues

## Context
Current state:
- `lib/move/client.ts` - Has view functions, no entry functions
- `lib/move/dungeonService.ts` - Calls backend API (correct)
- `hooks/useDungeonClaim.ts` - Calls `exitDungeonSuccess` (correct)
- `components/modals/DeathScreen.tsx` - Has TODO for chain call

The pattern: User actions that need server auth go through backend API. User actions that don't (like init_stash, enter_dungeon) need direct wallet signing.

## Tasks

### 4.1 Create Transaction Hook (hooks/useTransaction.ts)

```typescript
export function useTransaction() {
  const { signAndSubmitTransaction } = useAptos(); // from @aptos-labs/wallet-adapter-react

  const submitTransaction = async (payload: EntryFunctionPayload) => {
    // Sign with user's wallet
    // Submit to chain
    // Wait for confirmation
    // Return result
  };

  return { submitTransaction, isPending, error };
}
```

### 4.2 Add Privy + Aptos Wallet Adapter

Update `app/providers.tsx`:

```typescript
import { AptosWalletAdapterProvider } from '@aptos-labs/wallet-adapter-react';

// Wrap PrivyProvider with AptosWalletAdapterProvider
// Configure for Movement testnet
```

### 4.3 Implement User-Signed Transactions

These don't need server auth:

**Initialize Stash:**
```typescript
// hooks/useStash.ts
export function useStash() {
  const { submitTransaction } = useTransaction();

  const initStash = async () => {
    return submitTransaction({
      function: `${CONTRACT}::stash::init_stash`,
      typeArguments: [],
      functionArguments: []
    });
  };
}
```

**Enter Dungeon:**
```typescript
// hooks/useDungeon.ts
export function useDungeon() {
  const enterDungeon = async (dungeonId: number) => {
    return submitTransaction({
      function: `${CONTRACT}::dungeon::enter_dungeon`,
      typeArguments: [],
      functionArguments: [dungeonId]
    });
  };
}
```

**Create Character:**
```typescript
// hooks/useCreateCharacter.ts - update existing
const createCharacter = async (characterClass: CharacterClass) => {
  return submitTransaction({
    function: `${CONTRACT}::hero::create_character`,
    typeArguments: [],
    functionArguments: [classToU8(characterClass)]
  });
};
```

### 4.4 Fix DeathScreen Chain Call

Update `components/modals/DeathScreen.tsx`:

```typescript
// Replace the TODO with actual call
import { reportPlayerDeath } from '@/lib/move/dungeonService';

const processDeathOnChain = async () => {
  setIsProcessing(true);
  try {
    const result = await reportPlayerDeath(address!);
    if (result.success) {
      setDeathChainConfirmed();
    } else {
      console.error('Death processing failed:', result.error);
    }
  } catch (error) {
    console.error('Failed to process death on chain:', error);
  } finally {
    setIsProcessing(false);
  }
};
```

### 4.5 Add Chain Event Listeners

Update `hooks/useChainEvents.ts`:

```typescript
export function useChainEvents() {
  const { address } = useWalletStore();

  useEffect(() => {
    if (!address) return;

    // Poll for events or use websocket
    const pollEvents = async () => {
      // Check for DungeonEntered, FloorCompleted, etc.
    };

    const interval = setInterval(pollEvents, 5000);
    return () => clearInterval(interval);
  }, [address]);
}
```

### 4.6 Update API Base URL

In `lib/move/dungeonService.ts`:
```typescript
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api';
```

Add to `.env.local`:
```env
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

## Acceptance Criteria
- [ ] User can create character (wallet signs)
- [ ] User can initialize stash (wallet signs)
- [ ] User can enter dungeon (wallet signs)
- [ ] Victory screen claims loot (backend API)
- [ ] Death screen burns items (backend API)
- [ ] No more TODO comments in DeathScreen

## Testing Flow
1. Connect wallet
2. Create character
3. Initialize stash
4. Enter dungeon
5. Play through floors (mock or skip)
6. Beat boss → Victory → Claim loot
7. OR die → Death → Items burned

## Next Prompt
Prompt 5 will add pixel art assets.

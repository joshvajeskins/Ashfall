# Prompt 8: Production Deployment Preparation

## Goal
Prepare the application for production deployment with proper configuration and optimizations.

## Pre-Check: Review Issues
Check all issue docs for deployment-related problems:
- `docs/issues/tooling/README.md`
- `docs/issues/movement/README.md`

## Tasks

### 8.1 Frontend Production Build

```bash
cd frontend
npm run build
npm run start  # Test production build locally
```

Verify:
- [ ] No build errors
- [ ] No TypeScript errors
- [ ] Bundle size reasonable (< 500KB gzipped)

### 8.2 Backend Production Build

```bash
cd backend
npm run build
npm run start  # Test production build
```

Verify:
- [ ] Compiles to JavaScript
- [ ] Runs without errors
- [ ] All env vars required

### 8.3 Environment Configuration

**Frontend (.env.production):**
```env
NEXT_PUBLIC_CONTRACT_ADDRESS=0xYOUR_ADDRESS
NEXT_PUBLIC_API_URL=https://api.ashfall.game
NEXT_PUBLIC_PRIVY_APP_ID=your_privy_app_id
NEXT_PUBLIC_MOVEMENT_RPC=https://testnet.movementnetwork.xyz/v1
```

**Backend (.env.production):**
```env
PORT=3001
NODE_ENV=production
MOVEMENT_RPC_URL=https://testnet.movementnetwork.xyz/v1
SERVER_PRIVATE_KEY=your_production_server_key
CONTRACT_ADDRESS=0xYOUR_ADDRESS
CORS_ORIGIN=https://ashfall.game
```

### 8.4 Deployment Options

**Frontend (Vercel - Recommended):**
```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
cd frontend
vercel --prod
```

**Backend (Railway/Render/Fly.io):**

Railway example:
```bash
# Install Railway CLI
npm i -g @railway/cli

# Deploy
cd backend
railway up
```

### 8.5 Security Checklist

- [ ] SERVER_PRIVATE_KEY not in git
- [ ] .env files in .gitignore
- [ ] CORS configured for production domain only
- [ ] Rate limiting on API routes
- [ ] Input validation on all endpoints
- [ ] HTTPS only in production

### 8.6 Add Rate Limiting (Backend)

```typescript
// src/middleware/rateLimit.ts
import rateLimit from 'express-rate-limit';

export const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: { error: 'Too many requests, please try again later' }
});

// Apply to routes
app.use('/api/', apiLimiter);
```

### 8.7 Add Health Checks

**Backend:**
```typescript
app.get('/api/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    version: process.env.npm_package_version
  });
});
```

**Frontend (pages/api/health.ts for Next.js):**
```typescript
export default function handler(req, res) {
  res.status(200).json({ status: 'healthy' });
}
```

### 8.8 Monitoring Setup

Add basic error logging:

```typescript
// Backend error handler
app.use((err, req, res, next) => {
  console.error(`[ERROR] ${new Date().toISOString()}`, {
    path: req.path,
    method: req.method,
    error: err.message,
    stack: err.stack
  });

  res.status(500).json({
    error: 'Internal server error',
    requestId: req.headers['x-request-id']
  });
});
```

### 8.9 Create README for Deployment

```markdown
# Ashfall Deployment

## Prerequisites
- Node.js 18+
- Movement testnet access
- Privy account
- Server wallet with MOVE for gas

## Deploy Contracts
```bash
cd contracts
aptos move publish --profile production
```

## Deploy Backend
```bash
cd backend
npm run build
# Deploy to your hosting provider
```

## Deploy Frontend
```bash
cd frontend
npm run build
vercel --prod
```

## Environment Variables
See .env.example files in each directory.
```

### 8.10 Final Verification

Test production deployment:
1. Access frontend via production URL
2. Connect wallet
3. Create character
4. Complete dungeon run
5. Verify transactions on Movement explorer

## Acceptance Criteria
- [ ] Frontend builds and deploys successfully
- [ ] Backend builds and deploys successfully
- [ ] All environment variables configured
- [ ] CORS and security properly configured
- [ ] Health checks working
- [ ] Full game flow works on production

## Post-Launch

After deployment:
1. Monitor error logs
2. Watch transaction success rates
3. Check gas costs
4. Gather user feedback
5. Document any new issues in `docs/issues/`

# Prompt 3: Deploy Contracts to Movement Testnet

## Goal
Deploy all Move contracts to Movement testnet and initialize server authorization.

## Pre-Check: Review Issues
Before starting, check these issue docs:
- `docs/issues/move/README.md` - Contract deployment issues
- `docs/issues/movement/README.md` - Movement network specifics
- `docs/issues/tooling/README.md` - CLI tool issues

## Context
Contracts are complete and tested locally:
- `hero.move` - Character management
- `enemies.move` - Enemy spawning
- `items.move` - Item resources
- `dungeon.move` - Dungeon runs
- `loot.move` - Drop tables
- `stash.move` - Safe storage

## Tasks

### 3.1 Configure Movement Profile

Create or verify Aptos CLI profile for Movement testnet:

```bash
# Check existing profiles
aptos config show-profiles

# Create Movement testnet profile
aptos init --profile movement-testnet \
  --network custom \
  --rest-url https://testnet.movementnetwork.xyz/v1

# Fund the account via faucet
# Movement testnet faucet: https://faucet.movementnetwork.xyz
```

### 3.2 Update Move.toml

Ensure `Move.toml` has correct addresses:

```toml
[package]
name = "ashfall"
version = "1.0.0"

[addresses]
ashfall = "_"  # Will be replaced at deploy time

[dependencies]
AptosFramework = { git = "https://github.com/movementlabsxyz/aptos-core.git", subdir = "aptos-move/framework/aptos-framework", rev = "main" }
```

### 3.3 Compile Contracts

```bash
cd contracts
aptos move compile --named-addresses ashfall=default
```

Verify all 6 modules compile without errors.

### 3.4 Deploy Contracts

```bash
cd contracts
aptos move publish \
  --profile movement-testnet \
  --named-addresses ashfall=default \
  --assume-yes
```

Record the deployed address from output.

### 3.5 Initialize Server Authorization

After deployment, add the server account as authorized:

```bash
# Get server account address
# This should match the SERVER_PRIVATE_KEY in backend/.env

aptos move run \
  --profile movement-testnet \
  --function-id '<deployed_address>::dungeon::add_server' \
  --args address:<server_address>
```

### 3.6 Update Environment Files

Update both frontend and backend:

**frontend/.env.local:**
```env
NEXT_PUBLIC_CONTRACT_ADDRESS=0xYOUR_DEPLOYED_ADDRESS
```

**backend/.env:**
```env
CONTRACT_ADDRESS=0xYOUR_DEPLOYED_ADDRESS
```

### 3.7 Verify Deployment

Test view functions work:

```bash
# Check dungeon max floors
aptos move view \
  --profile movement-testnet \
  --function-id '<deployed_address>::dungeon::max_floors'

# Should return [5]
```

## Acceptance Criteria
- [ ] All 6 modules deployed successfully
- [ ] Deployment address recorded
- [ ] Server address added to authorized list
- [ ] Environment files updated
- [ ] View functions return expected values

## Troubleshooting

### "Account not found"
Fund the deployer account via Movement faucet.

### "Module verification failed"
Check dependencies match Movement's aptos-core version.

### "E_UNAUTHORIZED after add_server"
Make sure you called `add_server` with the admin account (deployer).

## Next Prompt
Prompt 4 will wire up frontend transaction signing.
